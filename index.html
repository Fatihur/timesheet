<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konverter PDF/Gambar Timesheet ke Excel dengan OCR</title>
    
    <!-- Menggunakan Tailwind CSS untuk styling yang modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Mengimpor library PDF.js dari Mozilla untuk memproses PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <!-- Mengimpor library SheetJS (xlsx) untuk membuat file Excel -->
    <script src="https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
    <!-- Fallback CDN untuk XLSX -->
    <script>
        // Check if XLSX loaded, if not try fallback
        window.addEventListener('load', function() {
            const updateStatus = (message, isError = false) => {
                const statusEl = document.getElementById('library-status');
                const iconEl = document.getElementById('library-loading-icon');
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = isError ?
                        'text-sm text-red-600 dark:text-red-400' :
                        'text-sm text-green-600 dark:text-green-400';
                }
                if (iconEl) {
                    if (isError) {
                        iconEl.className = 'fas fa-exclamation-triangle text-red-500';
                    } else if (message.includes('ready')) {
                        iconEl.className = 'fas fa-check-circle text-green-500';
                    } else {
                        iconEl.className = 'fas fa-cog animate-spin text-indigo-500';
                    }
                }
            };

            if (typeof XLSX === 'undefined') {
                console.log('Primary XLSX CDN failed, loading fallback...');
                updateStatus('Loading Excel library (fallback)...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = function() {
                    console.log('Fallback XLSX library loaded successfully');
                    updateStatus('✓ Excel library ready');
                };
                script.onerror = function() {
                    console.error('Both XLSX CDNs failed to load');
                    updateStatus('✗ Excel library failed to load', true);
                    alert('Error: Excel library failed to load. Please check your internet connection and refresh the page.');
                };
                document.head.appendChild(script);
            } else {
                console.log('XLSX library loaded successfully from primary CDN');
                updateStatus('✓ Excel library ready');
            }
        });
    </script>
    
    <style>
        /* Custom styles untuk tampilan yang lebih baik */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .main-container {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .dark .main-container {
            background: rgba(31, 41, 55, 0.95);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }

        .file-input-label {
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
        }

        .file-input-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .file-input-label:hover::before {
            left: 100%;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .pdf-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .pdf-button:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .image-button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .image-button:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }

        #progress-bar {
            transition: width 0.3s ease-in-out;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        /* Style untuk preview table */
        #preview-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark #preview-container {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }

        #preview-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #preview-container th, #preview-container td {
            border: 1px solid rgba(229, 231, 235, 0.5);
            padding: 0.75rem;
            text-align: center;
            transition: background-color 0.2s ease;
        }

        #preview-container th {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        #preview-container tbody tr:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .status-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .status-container {
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
                padding: 1.5rem;
            }

            .file-input-label {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl main-container rounded-3xl p-8 space-y-8 fade-in">
        <div class="text-center space-y-4">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl mb-4">
                <i class="fas fa-file-excel text-3xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                Timesheet PDF/Gambar to Excel
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
                Ubah PDF atau Gambar Timesheet menjadi lembar Excel dengan pewarnaan otomatis menggunakan teknologi OCR terdepan.
            </p>
            <div class="flex items-center justify-center space-x-6 text-sm text-gray-500 dark:text-gray-400">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Multiple Files</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Auto Time Format</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Smart Coloring</span>
                </div>
            </div>
        </div>

        <!-- Area Input File -->
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- PDF Upload -->
                <div class="group">
                    <label for="pdf-file" class="file-input-label pdf-button inline-block w-full text-center text-white font-semibold py-4 px-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-center space-x-3">
                            <i class="fas fa-file-pdf text-2xl"></i>
                            <div class="text-left">
                                <div class="font-bold">Pilih File PDF</div>
                                <div class="text-sm opacity-90">Bisa multiple files</div>
                            </div>
                        </div>
                    </label>
                    <input type="file" id="pdf-file" class="hidden" accept=".pdf" multiple>
                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        Mendukung PDF multi-halaman
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="group">
                    <label for="image-file" class="file-input-label image-button inline-block w-full text-center text-white font-semibold py-4 px-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-center space-x-3">
                            <i class="fas fa-images text-2xl"></i>
                            <div class="text-left">
                                <div class="font-bold">Pilih File Gambar</div>
                                <div class="text-sm opacity-90">Bisa multiple files</div>
                            </div>
                        </div>
                    </label>
                    <input type="file" id="image-file" class="hidden" accept="image/*,.jpg,.jpeg,.png,.gif,.bmp,.webp" multiple>
                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        JPG, PNG, GIF, BMP, WebP
                    </div>
                </div>
            </div>

            <!-- File Status -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 border-2 border-dashed border-gray-300 dark:border-gray-600">
                <div class="flex items-center justify-center space-x-2">
                    <i class="fas fa-folder-open text-gray-400"></i>
                    <p id="file-name" class="text-sm text-gray-500 dark:text-gray-400">Belum ada file yang dipilih</p>
                </div>
            </div>
        </div>
         
        <!-- Area Pilih Periode Bulan & Tahun -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 rounded-xl p-6 border border-blue-200 dark:border-gray-600">
            <div class="flex items-center space-x-2 mb-4">
                <i class="fas fa-calendar-alt text-indigo-600 dark:text-indigo-400"></i>
                <h3 class="font-semibold text-gray-800 dark:text-gray-200">Periode Timesheet</h3>
            </div>
            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-6 space-y-4 sm:space-y-0">
                <div class="flex-1">
                    <label for="periode-dari" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Dari:</label>
                    <input type="month" id="periode-dari" class="w-full border-2 border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200" value="2025-05">
                </div>
                <div class="flex items-center justify-center">
                    <i class="fas fa-arrow-right text-gray-400 text-lg"></i>
                </div>
                <div class="flex-1">
                    <label for="periode-ke" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sampai:</label>
                    <input type="month" id="periode-ke" class="w-full border-2 border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 transition-all duration-200" value="2025-06">
                </div>
            </div>
        </div>

        <!-- Tombol Aksi -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button id="preview-btn" class="btn-primary w-full text-white font-bold py-4 px-6 rounded-xl shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none transition-all duration-300" disabled>
                <div class="flex items-center justify-center space-x-3">
                    <i class="fas fa-eye text-xl"></i>
                    <span>Buat Preview</span>
                </div>
            </button>
            <button id="download-btn" class="btn-success w-full text-white font-bold py-4 px-6 rounded-xl shadow-lg hidden transition-all duration-300">
                <div class="flex items-center justify-center space-x-3">
                    <i class="fas fa-download text-xl"></i>
                    <span>Download Excel</span>
                </div>
            </button>
        </div>

        <!-- Library Status and Test Button (temporary) -->
        <div class="text-center space-y-3">
            <div class="flex items-center justify-center space-x-2">
                <i class="fas fa-cog animate-spin text-indigo-500" id="library-loading-icon"></i>
                <div id="library-status" class="text-sm text-gray-600 dark:text-gray-400">
                    Loading Excel library...
                </div>
            </div>
            <button id="test-xlsx-btn" class="btn-warning text-white font-semibold py-2 px-4 rounded-lg text-sm">
                <i class="fas fa-vial mr-2"></i>
                Test XLSX Library
            </button>
        </div>
        
        <!-- Area Status dan Hasil -->
        <div id="status-container" class="status-container text-center p-6 rounded-xl min-h-[120px] flex flex-col items-center justify-center space-y-4 border border-gray-200 dark:border-gray-600">
            <div class="flex items-center space-x-3">
                <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                <p id="status" class="text-gray-600 dark:text-gray-300 font-medium">Silakan pilih file PDF atau gambar (bisa banyak) dan klik "Buat Preview".</p>
            </div>
            <div id="progress-container" class="w-full max-w-md hidden">
                <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-400 mb-2">
                    <span>Progress</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-600 overflow-hidden">
                    <div id="progress-bar" class="h-3 rounded-full text-xs font-medium text-white text-center leading-none transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Area untuk menampilkan preview tabel -->
        <div id="preview-container" class="mt-6 p-6 rounded-xl overflow-x-auto border border-gray-200 dark:border-gray-600">
            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                <i class="fas fa-table text-4xl mb-4 opacity-50"></i>
                <p class="text-lg font-medium">Preview akan ditampilkan di sini</p>
                <p class="text-sm">Upload file dan klik "Buat Preview" untuk melihat hasil</p>
            </div>
        </div>

    </div>

    <script>
        // Penting: Atur lokasi worker untuk PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        // Seleksi elemen DOM
        const pdfFileInput = document.getElementById('pdf-file');
        const imageFileInput = document.getElementById('image-file');
        const previewBtn = document.getElementById('preview-btn');
        const downloadBtn = document.getElementById('download-btn');
        const fileNameDisplay = document.getElementById('file-name');
        const statusDisplay = document.getElementById('status');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const previewContainer = document.getElementById('preview-container');
        const statusContainerDiv = document.getElementById('status-container');
        const periodeDariInput = document.getElementById('periode-dari');
        const periodeKeInput = document.getElementById('periode-ke');
        const testXlsxBtn = document.getElementById('test-xlsx-btn');
        const libraryStatus = document.getElementById('library-status');

        let selectedFiles = []; // Array untuk menyimpan multiple files (PDF atau Image)
        let fileType = null; // 'pdf' atau 'image'
        let processedData = null; // Menyimpan data hasil proses untuk di-download
        let periodeDari = '2025-05';
        let periodeKe = '2025-06';

        // Event listener saat file dipilih
        function handleFileSelection(event, type) {
            fileType = type;
            selectedFiles = Array.from(event.target.files);

            // Reset input lainnya
            if (type === 'pdf') {
                imageFileInput.value = '';

                if (selectedFiles.length > 0) {
                    if (selectedFiles.length === 1) {
                        fileNameDisplay.textContent = `File terpilih: ${selectedFiles[0].name} (PDF)`;
                    } else {
                        fileNameDisplay.textContent = `${selectedFiles.length} file PDF terpilih: ${selectedFiles.map(f => f.name).join(', ')}`;
                    }
                    previewBtn.disabled = false;
                    downloadBtn.classList.add('hidden');
                    previewContainer.innerHTML = '';
                } else {
                    fileNameDisplay.textContent = 'Belum ada file yang dipilih.';
                    previewBtn.disabled = true;
                }
            } else {
                pdfFileInput.value = '';

                if (selectedFiles.length > 0) {
                    if (selectedFiles.length === 1) {
                        fileNameDisplay.textContent = `File terpilih: ${selectedFiles[0].name} (GAMBAR)`;
                    } else {
                        fileNameDisplay.textContent = `${selectedFiles.length} file gambar terpilih: ${selectedFiles.map(f => f.name).join(', ')}`;
                    }
                    previewBtn.disabled = false;
                    downloadBtn.classList.add('hidden');
                    previewContainer.innerHTML = '';
                } else {
                    fileNameDisplay.textContent = 'Belum ada file yang dipilih.';
                    previewBtn.disabled = true;
                }
            }
        }

        pdfFileInput.addEventListener('change', (event) => handleFileSelection(event, 'pdf'));
        imageFileInput.addEventListener('change', (event) => handleFileSelection(event, 'image'));
        
        periodeDariInput.addEventListener('change', (e) => { periodeDari = e.target.value; });
        periodeKeInput.addEventListener('change', (e) => { periodeKe = e.target.value; });

        // Test XLSX library
        testXlsxBtn.addEventListener('click', () => {
            console.log('Testing XLSX library...');
            console.log('XLSX object:', typeof XLSX !== 'undefined' ? XLSX : 'undefined');

            if (typeof XLSX === 'undefined') {
                alert('XLSX library is not loaded yet. Please wait a moment and try again, or refresh the page.');
                return;
            }

            try {
                // Create a simple test workbook
                const testWorkbook = XLSX.utils.book_new();
                const testData = [
                    ['Name', 'Age', 'City'],
                    ['John', 30, 'New York'],
                    ['Jane', 25, 'Los Angeles']
                ];
                const testWorksheet = XLSX.utils.aoa_to_sheet(testData);
                XLSX.utils.book_append_sheet(testWorkbook, testWorksheet, 'Test Sheet');

                // Try to download
                XLSX.writeFile(testWorkbook, 'test_file.xlsx');
                alert('Test Excel file should have been downloaded successfully!');
            } catch (error) {
                console.error('XLSX test failed:', error);
                alert(`XLSX test failed: ${error.message}`);
            }
        });

        // Event listener untuk tombol preview dan download
        previewBtn.addEventListener('click', handleConversion);
        downloadBtn.addEventListener('click', () => {
            console.log('Download button clicked');
            console.log('processedData:', processedData);
            console.log('XLSX library:', typeof XLSX);

            if (processedData) {
                let baseFileName = 'timesheet';

                if (fileType === 'pdf') {
                    if (selectedFiles.length === 1) {
                        baseFileName = selectedFiles[0].name.replace('.pdf', '');
                    } else if (selectedFiles.length > 1) {
                        baseFileName = `multiple_pdfs_${selectedFiles.length}_files`;
                    }
                } else if (fileType === 'image') {
                    if (selectedFiles.length === 1) {
                        baseFileName = selectedFiles[0].name.replace(/\.[^/.]+$/, '');
                    } else if (selectedFiles.length > 1) {
                        baseFileName = `multiple_images_${selectedFiles.length}_files`;
                    }
                }

                console.log('Calling generateExcel with baseFileName:', baseFileName);
                try {
                    generateExcel(processedData, baseFileName);
                    console.log('generateExcel completed successfully');
                } catch (error) {
                    console.error('Error in generateExcel:', error);
                    alert(`Error generating Excel file: ${error.message}`);
                }
            } else {
                alert('Tidak ada data untuk di-download. Silakan buat preview terlebih dahulu.');
            }
        });

        /**
         * Fungsi utama untuk menangani proses konversi dari PDF/Gambar ke data JSON
         */
        async function handleConversion() {
            if (selectedFiles.length === 0 || !fileType) {
                updateStatus('Error: Tidak ada file yang dipilih.', true);
                return;
            }

            // Reset UI
            previewBtn.disabled = true;
            downloadBtn.classList.add('hidden');
            pdfFileInput.disabled = true;
            imageFileInput.disabled = true;
            progressContainer.classList.remove('hidden');
            previewContainer.innerHTML = '';
            updateProgress(0, 0, 0);

            try {
                if (fileType === 'pdf') {
                    await handlePDFConversion();
                } else if (fileType === 'image') {
                    await handleImageConversion();
                }
            } catch (error) {
                console.error('Terjadi kesalahan:', error);
                updateStatus(`Error: ${error.message}`, true);
                previewBtn.disabled = false;
                pdfFileInput.disabled = false;
                imageFileInput.disabled = false;
            }
        }

        /**
         * Fungsi untuk menangani konversi PDF (single atau multiple)
         */
        async function handlePDFConversion() {
            const totalFiles = selectedFiles.length;
            const allPagesData = [];
            let totalPagesProcessed = 0;
            let totalPagesCount = 0;

            updateProgress(0, 0, totalFiles, `Memproses ${totalFiles} file PDF...`);

            // Hitung total halaman dari semua PDF
            for (let fileIndex = 0; fileIndex < totalFiles; fileIndex++) {
                const file = selectedFiles[fileIndex];
                try {
                    const arrayBuffer = await readFileAsArrayBuffer(file);
                    const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) }).promise;
                    totalPagesCount += pdf.numPages;
                } catch (error) {
                    console.error(`Error reading PDF ${file.name}:`, error);
                }
            }

            // Proses setiap PDF
            for (let fileIndex = 0; fileIndex < totalFiles; fileIndex++) {
                const file = selectedFiles[fileIndex];
                const currentFileNum = fileIndex + 1;

                updateProgress(
                    Math.round((totalPagesProcessed / totalPagesCount) * 100),
                    currentFileNum,
                    totalFiles,
                    `Memproses PDF ${currentFileNum}/${totalFiles}: ${file.name}`
                );

                try {
                    const arrayBuffer = await readFileAsArrayBuffer(file);
                    const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) }).promise;
                    const numPages = pdf.numPages;

                    for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                        updateProgress(
                            Math.round((totalPagesProcessed / totalPagesCount) * 100),
                            currentFileNum,
                            totalFiles,
                            `Memproses PDF ${currentFileNum}/${totalFiles}, halaman ${pageNum}/${numPages}`
                        );

                        const page = await pdf.getPage(pageNum);
                        const viewport = page.getViewport({ scale: 2.0 });
                        const canvas = document.createElement('canvas');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        const context = canvas.getContext('2d');
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        const base64ImageData = canvas.toDataURL('image/jpeg').split(',')[1];

                        const structuredData = await getStructuredDataFromImage(base64ImageData, pageNum);
                        if (structuredData) {
                            // Tambahkan nama file ke sheet name jika multiple files
                            if (totalFiles > 1) {
                                structuredData.sheetName = `${file.name.replace('.pdf', '')} - ${structuredData.sheetName || `Halaman ${pageNum}`}`;
                            }
                            // Konversi format waktu dari AM/PM ke 24 jam
                            const processedData = processTimeFormat(structuredData);
                            allPagesData.push(processedData);
                        }

                        totalPagesProcessed++;
                    }
                } catch (error) {
                    console.error(`Error processing PDF ${file.name}:`, error);
                    // Tetap lanjutkan dengan file lainnya
                    allPagesData.push({
                        sheetName: `${file.name} (Error)`,
                        tableData: [[`Error memproses ${file.name}: ${error.message}`]]
                    });
                }
            }

            await finishConversion(allPagesData, totalPagesCount);
        }

        /**
         * Fungsi untuk menangani konversi gambar (single atau multiple)
         */
        async function handleImageConversion() {
            const totalFiles = selectedFiles.length;
            const allPagesData = [];

            updateProgress(0, 0, totalFiles, `Memproses ${totalFiles} file gambar...`);

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const currentFileNum = i + 1;

                updateProgress(Math.round((i / totalFiles) * 100), currentFileNum, totalFiles, `Memproses gambar ${currentFileNum}/${totalFiles}: ${file.name}`);

                try {
                    const base64ImageData = await readFileAsBase64(file);
                    updateProgress(Math.round(((i + 0.5) / totalFiles) * 100), currentFileNum, totalFiles, `Menganalisis gambar ${currentFileNum}/${totalFiles} dengan OCR...`);

                    const structuredData = await getStructuredDataFromImage(base64ImageData, currentFileNum);
                    if (structuredData) {
                        // Tambahkan nama file ke sheet name jika multiple files
                        if (totalFiles > 1) {
                            structuredData.sheetName = `${file.name.replace(/\.[^/.]+$/, "")} - ${structuredData.sheetName || `Halaman ${currentFileNum}`}`;
                        }
                        // Konversi format waktu dari AM/PM ke 24 jam
                        const processedData = processTimeFormat(structuredData);
                        allPagesData.push(processedData);
                    }
                } catch (error) {
                    console.error(`Error processing file ${file.name}:`, error);
                    // Tetap lanjutkan dengan file lainnya
                    allPagesData.push({
                        sheetName: `${file.name} (Error)`,
                        tableData: [[`Error memproses ${file.name}: ${error.message}`]]
                    });
                }
            }

            await finishConversion(allPagesData, totalFiles);
        }

        /**
         * Helper function untuk membaca file sebagai base64
         */
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.onload = (event) => {
                    const base64Data = event.target.result.split(',')[1];
                    resolve(base64Data);
                };
                fileReader.onerror = () => reject(new Error('Gagal membaca file'));
                fileReader.readAsDataURL(file);
            });
        }

        /**
         * Helper function untuk membaca file sebagai ArrayBuffer (untuk PDF)
         */
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.onload = (event) => {
                    resolve(event.target.result);
                };
                fileReader.onerror = () => reject(new Error('Gagal membaca file PDF'));
                fileReader.readAsArrayBuffer(file);
            });
        }

        /**
         * Fungsi untuk menyelesaikan proses konversi
         */
        async function finishConversion(allPagesData, totalPages) {
            if (allPagesData.length > 0) {
                processedData = allPagesData;
                updateProgress(100, totalPages, totalPages, 'Membuat preview...');
                renderPreview(processedData);
                updateStatus('Preview berhasil dibuat. Anda sekarang bisa men-download file Excel.', false);
                downloadBtn.classList.remove('hidden');
            } else {
                updateStatus(`Tidak ada data yang dapat diekstrak dari ${fileType === 'pdf' ? 'PDF' : 'gambar'}.`, true);
            }

            previewBtn.disabled = false;
            pdfFileInput.disabled = false;
            imageFileInput.disabled = false;
            progressContainer.classList.add('hidden');
        }

        async function getStructuredDataFromImage(base64ImageData, pageNumber) {
            const model = 'gemini-2.0-flash'; 
            const apiKey = "AIzaSyBiGJ2FuKOZvMvYDteueIPd5YJcacgycwU"; // API Key dikosongkan untuk keamanan
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const prompt = `
            Analisis gambar timesheet. Ekstrak data ke format JSON.
            HANYA KEMBALIKAN BLOK KODE JSON, tidak ada teks lain.
            PASTIKAN JSON SELALU VALID. Jangan gunakan koma di akhir (trailing comma).

            Gunakan struktur ini:
            {
              "sheetName": "NAMA PERSONEL",
              "headerInfo": {
                "Nama": "NAMA PERSONEL",
                "Posisi": "POSISI",
                "Level": "LEVEL",
                "Lokasi": "LOKASI",
                "No. Badge": "NOMOR BADGE"
              },
              "tableData": [
                ["No", "Hari", "Tanggal", "Time in", "Time out"],
                ["1", "Senin", "19-May-2025", "07:00", "17:00"],
                ["6", "Sabtu", "24-May-2025", "OFF", "OFF"]
              ]
            }

            ATURAN:
            - Format tanggal persis "DD-Mon-YYYY".
            - Format waktu ekstrak apa adanya (bisa "HH:MM", "H:MM AM/PM", atau format lain yang terdeteksi).
            - Jika nama tidak ada, 'sheetName' diisi "Halaman ${pageNumber}".
            `;
            
            const payload = {
                contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } } ] }],
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const jsonString = result.candidates[0].content.parts[0].text;
                let cleanedJsonString = jsonString.replace(/```json\n?/g, '').replace(/```\n?$/, '').replace(/,(?=\s*[}\]])/g, '');
                return JSON.parse(cleanedJsonString);
            } catch (error) {
                console.error(`Error saat OCR: ${error.message}`);
                return { sheetName: `Halaman ${pageNumber} (Error)`, tableData: [[`Error saat OCR: ${error.message}`]] };
            }
        }
        
        const tanggalMerah = ['2025-01-01', '2025-01-27', '2025-01-29', '2025-03-29', '2025-03-31', '2025-04-01', '2025-04-18', '2025-05-01', '2025-05-12', '2025-05-29', '2025-06-01', '2025-06-06', '2025-06-26', '2025-08-17', '2025-09-05', '2025-12-25'];
        const monthMap = { 'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5, 'jul': 6, 'aug': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11 };

        /**
         * Fungsi untuk mengkonversi waktu dari format 12 jam (AM/PM) ke format 24 jam
         */
        function convertTo24Hour(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return timeStr;

            const str = timeStr.trim().toUpperCase();

            // Jika sudah format 24 jam atau tidak mengandung AM/PM, return as is
            if (!str.includes('AM') && !str.includes('PM')) return timeStr;

            // Pattern untuk menangkap waktu dengan AM/PM
            const timePattern = /(\d{1,2}):?(\d{0,2})\s*(AM|PM)/i;
            const match = str.match(timePattern);

            if (!match) return timeStr;

            let hours = parseInt(match[1], 10);
            let minutes = match[2] ? parseInt(match[2], 10) : 0;
            const period = match[3].toUpperCase();

            // Konversi ke format 24 jam
            if (period === 'AM') {
                if (hours === 12) hours = 0; // 12 AM = 00:xx
            } else if (period === 'PM') {
                if (hours !== 12) hours += 12; // PM kecuali 12 PM
            }

            // Format dengan leading zero
            const formattedHours = hours.toString().padStart(2, '0');
            const formattedMinutes = minutes.toString().padStart(2, '0');

            console.log(`Converted time: "${timeStr}" -> "${formattedHours}:${formattedMinutes}"`);
            return `${formattedHours}:${formattedMinutes}`;
        }

        /**
         * Fungsi untuk memproses data dan mengkonversi format waktu
         */
        function processTimeFormat(structuredData) {
            if (!structuredData || !structuredData.tableData || !Array.isArray(structuredData.tableData)) {
                return structuredData;
            }

            // Cari indeks kolom Time In dan Time Out
            const header = structuredData.tableData[0] || [];
            const timeInColIdx = header.findIndex(h =>
                h && (h.toLowerCase().includes('time in') || h.toLowerCase().includes('masuk'))
            );
            const timeOutColIdx = header.findIndex(h =>
                h && (h.toLowerCase().includes('time out') || h.toLowerCase().includes('keluar'))
            );

            // Jika tidak ada kolom waktu, return data asli
            if (timeInColIdx === -1 && timeOutColIdx === -1) {
                return structuredData;
            }

            // Proses setiap baris data (skip header)
            const processedTableData = structuredData.tableData.map((row, rowIndex) => {
                if (rowIndex === 0) return row; // Skip header row

                const newRow = [...row]; // Copy array

                // Konversi Time In jika ada
                if (timeInColIdx !== -1 && newRow[timeInColIdx]) {
                    newRow[timeInColIdx] = convertTo24Hour(newRow[timeInColIdx]);
                }

                // Konversi Time Out jika ada
                if (timeOutColIdx !== -1 && newRow[timeOutColIdx]) {
                    newRow[timeOutColIdx] = convertTo24Hour(newRow[timeOutColIdx]);
                }

                return newRow;
            });

            // Return data dengan waktu yang sudah dikonversi
            return {
                ...structuredData,
                tableData: processedTableData
            };
        }

        function parseDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            const str = dateStr.trim();

            // Pattern 1: DD-Mon-YYYY (seperti "21-Jun-2025")
            const monthMatch = str.match(/(\d{1,2})\s*[-/]\s*([a-zA-Z]{3,})\s*[-/]\s*(\d{2,4})/);
            if (monthMatch) {
                const day = parseInt(monthMatch[1], 10);
                const monthKey = monthMatch[2].toLowerCase().substring(0, 3); // Ambil 3 huruf pertama
                let year = parseInt(monthMatch[3], 10);
                if (year < 100) year += 2000;
                if (monthMap[monthKey] !== undefined) {
                    const parsedDate = new Date(Date.UTC(year, monthMap[monthKey], day));
                    console.log(`Parsed date "${str}" -> ${parsedDate.toISOString()}`);
                    return parsedDate;
                }
            }

            // Pattern 2: YYYY-MM-DD
            const isoMatch = str.match(/(\d{4})\s*[-/]\s*(\d{1,2})\s*[-/]\s*(\d{1,2})/);
            if (isoMatch) {
                const year = parseInt(isoMatch[1], 10);
                const month = parseInt(isoMatch[2], 10) - 1; // Month is 0-indexed
                const day = parseInt(isoMatch[3], 10);
                const parsedDate = new Date(Date.UTC(year, month, day));
                console.log(`Parsed ISO date "${str}" -> ${parsedDate.toISOString()}`);
                return parsedDate;
            }

            // Fallback: coba parse dengan Date constructor
            const d = new Date(str);
            if (!isNaN(d.getTime())) {
                const utcDate = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                console.log(`Fallback parsed date "${str}" -> ${utcDate.toISOString()}`);
                return utcDate;
            }

            console.log(`Failed to parse date: "${str}"`);
            return null;
        }
        
        function getHighlightInfo(dateStr) {
            const date = parseDate(dateStr);
            if (!date) return null;
            const dayOfWeek = date.getUTCDay(), isoDate = date.toISOString().slice(0, 10);

            // Debug logging untuk memastikan parsing bekerja
            console.log(`Date: ${dateStr} -> Parsed: ${date.toISOString()} -> Day of week: ${dayOfWeek} (0=Sunday, 6=Saturday)`);

            if (tanggalMerah.includes(isoDate)) return { type: 'holiday' };
            if (dayOfWeek === 0 || dayOfWeek === 6) return { type: 'weekend' };
            return null;
        }
        
        function renderPreview(allPagesData) {
            previewContainer.innerHTML = '';
            allPagesData.forEach(pageData => {
                const sheetDiv = document.createElement('div');
                sheetDiv.className = 'mb-8';

                const sheetTitle = document.createElement('h3');
                sheetTitle.className = 'text-xl font-bold mb-2 text-gray-800 dark:text-gray-200';
                sheetTitle.textContent = pageData.sheetName || 'Untitled Sheet';
                sheetDiv.appendChild(sheetTitle);

                const table = document.createElement('table');
                table.className = 'w-full text-sm text-left text-gray-500 dark:text-gray-400';
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');

                const finalSheetData = [];
                if (pageData.headerInfo) {
                    Object.entries(pageData.headerInfo).forEach(([key, value]) => finalSheetData.push({type: 'info', data: [key, value || ""]}));
                    finalSheetData.push({type: 'spacer'});
                }
                 if (pageData.tableData && Array.isArray(pageData.tableData)) {
                    if(pageData.tableData[0]) finalSheetData.push({type: 'header', data: pageData.tableData[0]});
                    pageData.tableData.slice(1).forEach(row => finalSheetData.push({type: 'data', data: row}));
                 }

                let tanggalColIdx = pageData.tableData?.[0]?.findIndex(h => h?.toLowerCase().includes('tanggal')) ?? -1;
                let hariColIdx = pageData.tableData?.[0]?.findIndex(h => h?.toLowerCase().includes('hari')) ?? -1;

                finalSheetData.forEach(rowData => {
                    const tr = document.createElement('tr');
                    
                    if(rowData.type === 'spacer' || !rowData.data) {
                        tr.innerHTML = `<td colspan="5" class="h-4 border-none"></td>`;
                        tbody.appendChild(tr);
                        return;
                    }
                    if(rowData.type === 'info') {
                        tr.innerHTML = `<td class="font-bold p-2 text-left border-none">${rowData.data[0]}</td><td class="p-2 text-left border-none" colspan="4">${rowData.data[1]}</td>`;
                        tbody.appendChild(tr);
                        return;
                    }
                    if(rowData.type === 'header'){
                         tr.className = 'bg-yellow-300 text-black font-bold';
                         rowData.data.forEach(cell => {
                            const th = document.createElement('th');
                            th.textContent = cell;
                            tr.appendChild(th);
                         });
                         thead.appendChild(tr);
                         return;
                    }
                    
                    const highlight = getHighlightInfo(rowData.data[tanggalColIdx]);
                    if(highlight?.type === 'weekend') tr.className = 'bg-yellow-100 dark:bg-yellow-900';
                    if(highlight?.type === 'holiday') tr.className = 'bg-red-100 dark:bg-red-900';

                    rowData.data.forEach((cell, cellIdx) => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        if (highlight && cellIdx === hariColIdx ) {
                             td.className = "text-red-600 font-semibold";
                        }
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                
                table.appendChild(thead);
                table.appendChild(tbody);
                sheetDiv.appendChild(table);
                previewContainer.appendChild(sheetDiv);
            });
        }

        /**
         * Fungsi untuk membuat nama sheet yang aman dan unik
         */
        function createSafeSheetName(originalName, index, usedNames) {
            // Clean the original name
            let safeName = (originalName || `Sheet_${index + 1}`)
                .replace(/[\/\\?*\[\]:]/g, '') // Remove invalid Excel sheet name characters
                .replace(/\|/g, '') // Remove pipe characters
                .replace(/[<>]/g, '') // Remove angle brackets
                .trim() // Remove leading/trailing spaces
                .substring(0, 31); // Excel sheet name limit

            // If name is empty after cleaning, use default
            if (!safeName) {
                safeName = `Sheet_${index + 1}`;
            }

            // Handle duplicates
            let finalName = safeName;
            let counter = 1;
            while (usedNames.has(finalName)) {
                const suffix = `_${counter}`;
                const maxLength = 31 - suffix.length;
                const truncatedName = safeName.substring(0, maxLength);
                finalName = `${truncatedName}${suffix}`;
                counter++;
            }

            return finalName;
        }

        // [PENDEKATAN TOTAL BARU] Fungsi generateExcel ditulis ulang dari nol
        function generateExcel(allPagesData, baseFileName) {
            console.log('generateExcel called with:', { allPagesData, baseFileName });

            if (typeof XLSX === 'undefined') {
                throw new Error('XLSX library not loaded');
            }

            const workbook = XLSX.utils.book_new();
            console.log('Workbook created:', workbook);

            // Track used sheet names to avoid duplicates
            const usedSheetNames = new Set();

            allPagesData.forEach((pageData, index) => {
                // Create safe and unique sheet name
                const sheetName = createSafeSheetName(pageData.sheetName, index, usedSheetNames);
                usedSheetNames.add(sheetName);

                console.log(`Processing sheet: "${pageData.sheetName}" -> "${sheetName}"`);

                // 1. Gabungkan semua data menjadi satu array
                const finalSheetData = [];
                if (pageData.headerInfo) {
                    Object.entries(pageData.headerInfo).forEach(([k, v]) => finalSheetData.push([k, v || ""]));
                    finalSheetData.push([]); // Baris kosong
                }
                const tableHeaderRowIndex = finalSheetData.length;
                if (pageData.tableData && Array.isArray(pageData.tableData)) {
                    finalSheetData.push(...pageData.tableData);
                }

                // 2. Buat worksheet dari data mentah
                const worksheet = XLSX.utils.aoa_to_sheet(finalSheetData);

                // 3. Cari kolom penting
                const header = pageData.tableData?.[0] || [];
                const tanggalColIdx = header.findIndex(h => h?.toLowerCase().includes('tanggal'));
                const hariColIdx = header.findIndex(h => h?.toLowerCase().includes('hari'));
                const timeInColIdx = header.findIndex(h => h?.toLowerCase().includes('time in') || h?.toLowerCase().includes('masuk'));
                const timeOutColIdx = header.findIndex(h => h?.toLowerCase().includes('time out') || h?.toLowerCase().includes('keluar'));

                // 4. Atur lebar kolom dengan ukuran yang lebih optimal
                const columnWidths = header.map((h, idx) => {
                    if (idx === tanggalColIdx) return { wch: 18 }; // Tanggal lebih lebar
                    if (idx === hariColIdx) return { wch: 12 }; // Hari sedang
                    if (idx === timeInColIdx || idx === timeOutColIdx) return { wch: 12 }; // Waktu sedang
                    return { wch: 10 }; // Default
                });
                worksheet['!cols'] = columnWidths;

                // 5. Iterasi dan terapkan gaya sel per sel dengan formatting yang lebih baik
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
                        if (!worksheet[cell_ref]) continue;

                        // Buat objek gaya baru untuk setiap sel dengan formatting yang lebih baik
                        let style = {
                            font: { name: "Calibri", sz: 11 },
                            alignment: { vertical: "center", wrapText: true },
                            border: {
                                top: { style: "thin", color: { rgb: "FF000000" } },
                                bottom: { style: "thin", color: { rgb: "FF000000" } },
                                left: { style: "thin", color: { rgb: "FF000000" } },
                                right: { style: "thin", color: { rgb: "FF000000" } }
                            }
                        };

                        if (R < tableHeaderRowIndex) {
                            // Styling untuk header info (Nama, Posisi, dll)
                            style.alignment.horizontal = "left";
                            style.border = {}; // Hapus border untuk header info
                            if (C === 0) {
                                style.font.bold = true;
                                style.font.color = { rgb: "FF1F4E79" }; // Biru tua
                            }
                        } else {
                            // Gaya untuk tabel data
                            style.alignment.horizontal = "center";

                            if (R === tableHeaderRowIndex) {
                                // Header Tabel - styling yang lebih menarik
                                style.font.bold = true;
                                style.font.color = { rgb: "FFFFFFFF" }; // Font putih
                                style.fill = { fgColor: { rgb: "FF4472C4" } }; // Biru header
                                style.alignment.horizontal = "center";
                            } else {
                                // Baris Data - deteksi weekend dan holiday
                                const dateValue = finalSheetData[R]?.[tanggalColIdx];
                                const hariValue = finalSheetData[R]?.[hariColIdx];
                                const highlight = getHighlightInfo(dateValue);

                                // Deteksi weekend berdasarkan nama hari juga (lebih robust)
                                const isWeekendByName = hariValue && (
                                    hariValue.toLowerCase().includes('sabtu') ||
                                    hariValue.toLowerCase().includes('minggu') ||
                                    hariValue.toLowerCase().includes('saturday') ||
                                    hariValue.toLowerCase().includes('sunday') ||
                                    hariValue.toLowerCase().includes('sat') ||
                                    hariValue.toLowerCase().includes('sun')
                                );

                                // Debug logging untuk Excel generation
                                console.log(`Excel Row ${R}: Date="${dateValue}", Day="${hariValue}", Highlight=${highlight?.type}, WeekendByName=${isWeekendByName}`);

                                if (highlight?.type === 'weekend' || isWeekendByName) {
                                    // SABTU & MINGGU - Background MERAH
                                    style.fill = { fgColor: { rgb: "FFFF0000" } }; // Merah murni untuk lebih jelas
                                    style.font.color = { rgb: "FFFFFFFF" }; // Font putih untuk kontras
                                    style.font.bold = true;
                                    console.log(`Applied weekend formatting to row ${R}`);
                                } else if (highlight?.type === 'holiday') {
                                    // HARI LIBUR NASIONAL - Background Merah Gelap
                                    style.fill = { fgColor: { rgb: "FFDC3545" } }; // Merah gelap
                                    style.font.color = { rgb: "FFFFFFFF" }; // Font putih
                                    style.font.bold = true;
                                    console.log(`Applied holiday formatting to row ${R}`);
                                } else {
                                    // HARI KERJA - Background putih
                                    style.fill = { fgColor: { rgb: "FFFFFFFF" } }; // Putih
                                    style.font.color = { rgb: "FF000000" }; // Font hitam
                                }

                                // Styling khusus untuk kolom waktu
                                if (C === timeInColIdx || C === timeOutColIdx) {
                                    const cellValue = finalSheetData[R]?.[C];
                                    if (cellValue && (cellValue.toLowerCase().includes('off') || cellValue.toLowerCase().includes('libur'))) {
                                        style.font.color = { rgb: "FFFF0000" }; // Font merah untuk OFF
                                        style.font.bold = true;
                                    }
                                }
                            }
                        }
                        worksheet[cell_ref].s = style;
                    }
                }
                
                try {
                    XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                    console.log(`Sheet "${sheetName}" added to workbook successfully`);
                } catch (sheetError) {
                    console.error(`Error adding sheet "${sheetName}":`, sheetError);
                    // Try with a fallback name
                    const fallbackName = `Sheet_${index + 1}_${Date.now()}`.substring(0, 31);
                    console.log(`Trying fallback name: "${fallbackName}"`);
                    XLSX.utils.book_append_sheet(workbook, worksheet, fallbackName);
                    console.log(`Fallback sheet "${fallbackName}" added successfully`);
                }
            });

            const fileName = `${baseFileName}_hasil_ocr.xlsx`;
            console.log('Attempting to write file:', fileName);

            try {
                XLSX.writeFile(workbook, fileName);
                console.log('File written successfully:', fileName);
            } catch (error) {
                console.error('Error writing file:', error);
                throw error;
            }
        }
        
        function updateProgress(percentage, currentPage, totalPages, message) {
            const progressText = document.getElementById('progress-text');
            progressBar.style.width = `${percentage}%`;
            if (progressText) {
                progressText.textContent = `${percentage}%`;
            }
            statusDisplay.textContent = message || `Memproses halaman ${currentPage} dari ${totalPages}...`;
        }

        function updateStatus(message, isError = false) {
            progressContainer.classList.add('hidden');
            statusDisplay.textContent = message;

            // Update status icon
            const statusIcon = statusContainerDiv.querySelector('i');
            if (statusIcon) {
                if (isError) {
                    statusIcon.className = 'fas fa-exclamation-triangle text-red-500 text-xl';
                } else {
                    statusIcon.className = 'fas fa-check-circle text-green-500 text-xl';
                }
            }

            const baseClasses = 'status-container text-center p-6 rounded-xl min-h-[120px] flex flex-col items-center justify-center space-y-4 border';
            const statusClasses = isError ?
                'border-red-300 bg-red-50 dark:bg-red-900/20 dark:border-red-700' :
                'border-green-300 bg-green-50 dark:bg-green-900/20 dark:border-green-700';
            statusContainerDiv.className = `${baseClasses} ${statusClasses}`;
        }
    </script>
</body>
</html>
